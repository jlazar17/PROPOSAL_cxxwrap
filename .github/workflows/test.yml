name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake g++ \
            libfmt-dev libspdlog-dev \
            nlohmann-json3-dev \
            libboost-all-dev libeigen3-dev \
            libgsl-dev

      - name: Install Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '1'

      - name: Get JlCxx prefix path
        id: jlcxx
        run: |
          julia -e 'using Pkg; Pkg.add("CxxWrap")'
          PREFIX=$(julia -e 'using CxxWrap; print(CxxWrap.prefix_path())')
          echo "prefix=$PREFIX" >> "$GITHUB_OUTPUT"

      - name: Build CubicInterpolation from source
        run: |
          git clone --depth 1 --branch v0.1.5 \
            https://github.com/MaxSac/cubic_interpolation.git /tmp/cubic_interpolation
          cmake -S /tmp/cubic_interpolation -B /tmp/cubic_interpolation/build \
            -DCMAKE_INSTALL_PREFIX=/tmp/deps \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF \
            -DBUILD_EXAMPLE=OFF
          cmake --build /tmp/cubic_interpolation/build --parallel $(nproc)
          cmake --install /tmp/cubic_interpolation/build

      - name: Build PROPOSAL from source
        run: |
          git clone --depth 1 --branch 7.6.2 \
            https://github.com/tudo-astroparticlephysics/PROPOSAL.git /tmp/PROPOSAL
          cmake -S /tmp/PROPOSAL -B /tmp/PROPOSAL/build \
            -DCMAKE_INSTALL_PREFIX=/tmp/PROPOSAL/install \
            -DCMAKE_PREFIX_PATH=/tmp/deps \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_TESTING=OFF \
            -DBUILD_PYTHON=OFF
          cmake --build /tmp/PROPOSAL/build --parallel $(nproc)
          cmake --install /tmp/PROPOSAL/build
          # Patch PROPOSALConfig.cmake: the set_and_check macro gets clobbered by
          # fmt's cmake config (transitive via spdlog), causing PACKAGE_PREFIX_DIR
          # to resolve incorrectly. Remove the legacy variable lines that trigger it.
          sed -i '/^set_and_check(PROPOSAL_/d' /tmp/PROPOSAL/install/lib/cmake/PROPOSAL/PROPOSALConfig.cmake

      - name: Build PROPOSAL_cxxwrap
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="/tmp/PROPOSAL/install;/tmp/deps;${{ steps.jlcxx.outputs.prefix }}" \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/install
          cmake --build build --parallel $(nproc)
          cmake --install build

      - name: Run Julia tests
        env:
          LIBPROPOSAL_CXXWRAP_PATH: ${{ github.workspace }}/install/lib/libPROPOSAL_cxxwrap.so
          LD_LIBRARY_PATH: /tmp/PROPOSAL/install/lib:/tmp/deps/lib:${{ github.workspace }}/install/lib
        run: |
          julia --project=test -e 'using Pkg; Pkg.instantiate()'
          julia --project=test test/runtests.jl
